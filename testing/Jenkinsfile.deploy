// Deploy Pipeline - Starts services and keeps them running
// Use this when you want to access the services after deployment

pipeline {
    agent any

    stages {
        stage('Deploy Services') {
            steps {
                dir('testing') {
                    sh '''
                        echo "==========================================="
                        echo "  PMS Backend - Deploying All Services"
                        echo "==========================================="

                        # Step 1: Start infrastructure (SQL Server, Kafka, Zookeeper)
                        echo "[1/6] Starting infrastructure services..."
                        docker compose -f docker-compose.ci.yml up -d zookeeper sqlserver
                        sleep 5
                        docker compose -f docker-compose.ci.yml up -d kafka

                        # Step 2: Wait for Kafka to be ready
                        echo "[2/6] Waiting for Kafka to be ready..."
                        for i in $(seq 1 30); do
                            if docker exec pms-kafka kafka-topics --list --bootstrap-server localhost:9092 2>/dev/null; then
                                echo "Kafka is ready!"
                                break
                            fi
                            echo "Waiting... ($i/30)"
                            sleep 2
                        done

                        # Step 3: Create Kafka topics
                        echo "[3/6] Creating Kafka topics..."
                        docker exec pms-kafka kafka-topics --create --topic site-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 2>/dev/null || echo "topic site-created exists"
                        docker exec pms-kafka kafka-topics --create --topic booking-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 2>/dev/null || echo "topic booking-created exists"
                        docker exec pms-kafka kafka-topics --create --topic ticket-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 2>/dev/null || echo "topic ticket-created exists"
                        docker exec pms-kafka kafka-topics --create --topic invoice-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 2>/dev/null || echo "topic invoice-created exists"

                        # Step 4: Wait for SQL Server and create databases
                        echo "[4/6] Waiting for SQL Server..."
                        for i in $(seq 1 30); do
                            if docker exec pms-sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong@Passw0rd" -C -Q "SELECT 1" 2>/dev/null; then
                                echo "SQL Server is ready!"
                                break
                            fi
                            echo "Waiting for SQL Server... ($i/30)"
                            sleep 2
                        done

                        # Create databases
                        docker exec pms-sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong@Passw0rd" -C -Q "IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'PMS_Site') CREATE DATABASE PMS_Site;" 2>/dev/null || true
                        docker exec pms-sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong@Passw0rd" -C -Q "IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'PMS_Booking') CREATE DATABASE PMS_Booking;" 2>/dev/null || true
                        docker exec pms-sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong@Passw0rd" -C -Q "IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'PMS_Invoice') CREATE DATABASE PMS_Invoice;" 2>/dev/null || true

                        # Run database migrations
                        echo "Creating database tables..."
                        cat init-db.sql | docker exec -i pms-sqlserver /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong@Passw0rd" -C > /dev/null 2>&1 || true

                        # Step 5: Start all services
                        echo "[5/6] Starting backend and frontend services..."
                        docker compose -f docker-compose.ci.yml up -d

                        # Wait for backend services to be healthy
                        echo "Waiting for backend services to be ready..."
                        for i in $(seq 1 60); do
                            BOOKING_OK=$(docker exec pms-admin-frontend wget -q --spider http://pms-booking-service:8080/api/booking 2>&1 && echo "1" || echo "0")
                            INVOICE_OK=$(docker exec pms-admin-frontend wget -q --spider http://pms-invoice-service:8080/api/invoice 2>&1 && echo "1" || echo "0")
                            SITE_OK=$(docker exec pms-admin-frontend wget -q --spider http://pms-site-service:8080/api/site 2>&1 && echo "1" || echo "0")

                            if [ "$BOOKING_OK" = "1" ] && [ "$INVOICE_OK" = "1" ] && [ "$SITE_OK" = "1" ]; then
                                echo "All backend services are ready!"
                                break
                            fi
                            echo "Waiting for services... ($i/60)"
                            sleep 5
                        done

                        # Step 6: Start Kafka UI
                        echo "[6/6] Starting Kafka UI..."
                        docker rm -f kafka-ui 2>/dev/null || true
                        docker run -d --name kafka-ui \
                          --network testing_pms-network \
                          -p 8085:8080 \
                          -e KAFKA_CLUSTERS_0_NAME=pms-kafka \
                          -e KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:9092 \
                          provectuslabs/kafka-ui:latest || true

                        echo ""
                        echo "==========================================="
                        echo "  DEPLOYMENT COMPLETE - Services Running!"
                        echo "==========================================="
                        echo ""
                        echo "Access URLs:"
                        echo "  Admin Frontend:  http://localhost:4200"
                        echo "  Parker Frontend: http://localhost:4201"
                        echo "  Kafka UI:        http://localhost:8085"
                        echo ""
                        echo "API Endpoints:"
                        echo "  Booking API:     http://localhost:5001/api/booking"
                        echo "  Invoice API:     http://localhost:5002/api/invoice"
                        echo "  Site API:        http://localhost:5003/api/site"
                        echo ""
                        echo "To stop services, run the 'pms-stop' job or:"
                        echo "  docker compose -f docker-compose.ci.yml down"
                        echo "  docker rm -f kafka-ui"
                        echo ""
                    '''
                }
            }
        }

        stage('Verify Deployment') {
            steps {
                sh '''
                    echo "Running containers:"
                    docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep -E "pms|kafka"
                '''
            }
        }
    }

    // NO cleanup in post - services stay running!
    post {
        failure {
            sh '''
                echo "=== Docker Logs ==="
                docker logs pms-sqlserver 2>&1 | tail -50 || true
                docker logs pms-kafka 2>&1 | tail -50 || true
            '''
        }
    }
}
