// PMS Deployment Pipeline
// Triggered after backend build pipeline completes
// Pulls images from Docker Hub and deploys to Docker Swarm

pipeline {
    agent any

    environment {
        STACK_NAME = 'pms'
        DOCKER_HUB_BACKEND = 'amaleltelabany'
        DOCKER_HUB_FRONTEND = 'salmawaleedd'
    }

    stages {
        stage('Pull All Images') {
            parallel {
                stage('Pull Backend Images') {
                    steps {
                        sh '''
                            echo "=========================================="
                            echo "  Pulling Backend Images (amaleltelabany)"
                            echo "=========================================="
                            docker pull ${DOCKER_HUB_BACKEND}/pms-booking-service:latest
                            docker pull ${DOCKER_HUB_BACKEND}/pms-invoice-service:latest
                            docker pull ${DOCKER_HUB_BACKEND}/pms-site-service:latest
                            echo "Backend images pulled!"
                        '''
                    }
                }
                stage('Pull Frontend Images') {
                    steps {
                        sh '''
                            echo "=========================================="
                            echo "  Pulling Frontend Images (salmawaleedd)"
                            echo "=========================================="
                            docker pull ${DOCKER_HUB_FRONTEND}/pms-admin-frontend:latest
                            docker pull ${DOCKER_HUB_FRONTEND}/pms-parker-frontend:latest
                            echo "Frontend images pulled!"
                        '''
                    }
                }
            }
        }

        stage('Clean Previous Stack') {
            steps {
                sh '''
                    if docker stack ls | grep -q "${STACK_NAME}"; then
                        echo "Removing existing stack..."
                        docker stack rm ${STACK_NAME}
                        sleep 20
                    fi
                '''
            }
        }

        stage('Deploy to Swarm') {
            steps {
                dir('testing') {
                    sh '''
                        echo "=========================================="
                        echo "  Deploying to Docker Swarm"
                        echo "=========================================="
                        docker stack deploy -c docker-stack.yml ${STACK_NAME}
                        sleep 30
                    '''
                }
            }
        }

        stage('Wait for Infrastructure') {
            steps {
                sh '''
                    echo "Waiting for Zookeeper..."
                    for i in $(seq 1 30); do
                        ZK=$(docker ps --filter "name=${STACK_NAME}_zookeeper" -q | head -1)
                        if [ -n "$ZK" ] && docker exec $ZK nc -z localhost 2181 2>/dev/null; then
                            echo "Zookeeper ready!"
                            break
                        fi
                        sleep 3
                    done

                    echo "Waiting for Kafka..."
                    for i in $(seq 1 60); do
                        KAFKA=$(docker ps --filter "name=${STACK_NAME}_kafka" -q | head -1)
                        if [ -n "$KAFKA" ] && docker exec $KAFKA kafka-topics --list --bootstrap-server localhost:9092 2>/dev/null; then
                            echo "Kafka ready!"
                            break
                        fi
                        sleep 5
                    done

                    echo "Waiting for SQL Server..."
                    for i in $(seq 1 60); do
                        SQL=$(docker ps --filter "name=${STACK_NAME}_sqlserver" -q | head -1)
                        if [ -n "$SQL" ] && docker exec $SQL /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong@Passw0rd" -C -Q "SELECT 1" 2>/dev/null; then
                            echo "SQL Server ready!"
                            break
                        fi
                        sleep 5
                    done
                '''
            }
        }

        stage('Create Kafka Topics') {
            steps {
                sh '''
                    KAFKA=$(docker ps --filter "name=${STACK_NAME}_kafka" -q | head -1)
                    docker exec $KAFKA kafka-topics --create --topic site-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || true
                    docker exec $KAFKA kafka-topics --create --topic booking-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || true
                    docker exec $KAFKA kafka-topics --create --topic ticket-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || true
                    docker exec $KAFKA kafka-topics --create --topic invoice-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || true
                    echo "Topics created!"
                    sleep 10
                '''
            }
        }

        stage('Restart Backend Services') {
            steps {
                sh '''
                    echo "Restarting backend services..."
                    docker service scale ${STACK_NAME}_booking-service=0 ${STACK_NAME}_invoice-service=0 ${STACK_NAME}_site-service=0 || true
                    sleep 10
                    docker service scale ${STACK_NAME}_booking-service=1 ${STACK_NAME}_invoice-service=1 ${STACK_NAME}_site-service=1
                    sleep 30
                '''
            }
        }

        stage('Health Check') {
            steps {
                sh '''
                    echo "=========================================="
                    echo "  Health Check"
                    echo "=========================================="
                    for i in $(seq 1 20); do
                        BOOKING=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5001/api/booking 2>/dev/null || echo "000")
                        INVOICE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5002/api/invoice 2>/dev/null || echo "000")
                        SITE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5003/api/site 2>/dev/null || echo "000")

                        echo "Booking: $BOOKING | Invoice: $INVOICE | Site: $SITE"

                        if [ "$BOOKING" = "200" ] && [ "$INVOICE" = "200" ] && [ "$SITE" = "200" ]; then
                            echo "All services healthy!"
                            break
                        fi
                        sleep 10
                    done

                    echo ""
                    docker stack services ${STACK_NAME}
                '''
            }
        }
    }

    post {
        success {
            echo '''
=========================================
  DEPLOYMENT SUCCESSFUL!
=========================================

Frontend:
  - Admin:  http://localhost:4200
  - Parker: http://localhost:4201

APIs:
  - Booking: http://localhost:5001/api/booking
  - Invoice: http://localhost:5002/api/invoice
  - Site:    http://localhost:5003/api/site

Monitoring:
  - Kibana:     http://localhost:5601
  - Kafka UI:   http://localhost:8085
  - Visualizer: http://localhost:9080
            '''
        }
        failure {
            sh 'docker stack services ${STACK_NAME} || true'
        }
    }
}
