// Full CI/CD Pipeline for PMS
// Builds backend services from private repo, pulls frontend from Docker Hub, deploys to Swarm

pipeline {
    agent any

    environment {
        STACK_NAME = 'pms'
        DOCKER_HUB_BACKEND = 'amaleltelabany'
        DOCKER_HUB_FRONTEND = 'salmawaleedd'
        BACKEND_REPO = 'https://github.com/GS-PMS/pms-backend.git'
    }

    stages {
        // =============================================
        // STAGE 1: Build Backend Services
        // =============================================
        stage('Checkout Backend Repo') {
            steps {
                // Clone the private backend repository
                git branch: 'main',
                    credentialsId: 'github-credentials',
                    url: "${BACKEND_REPO}"
            }
        }

        stage('Show Project Structure') {
            steps {
                sh '''
                    echo "=========================================="
                    echo "  Project Structure"
                    echo "=========================================="
                    ls -la
                    echo ""
                    echo "Looking for Dockerfiles..."
                    find . -name "Dockerfile" -type f 2>/dev/null || echo "No Dockerfiles found"
                '''
            }
        }

        stage('Build Backend Images') {
            parallel {
                stage('Build Booking Service') {
                    steps {
                        sh '''
                            echo "Building Booking Service..."
                            docker build -f Booking.API/Dockerfile -t ${DOCKER_HUB_BACKEND}/pms-booking-service:${BUILD_NUMBER} .
                            docker tag ${DOCKER_HUB_BACKEND}/pms-booking-service:${BUILD_NUMBER} ${DOCKER_HUB_BACKEND}/pms-booking-service:latest
                        '''
                    }
                }
                stage('Build Invoice Service') {
                    steps {
                        sh '''
                            echo "Building Invoice Service..."
                            docker build -f Invoice.API/Dockerfile -t ${DOCKER_HUB_BACKEND}/pms-invoice-service:${BUILD_NUMBER} .
                            docker tag ${DOCKER_HUB_BACKEND}/pms-invoice-service:${BUILD_NUMBER} ${DOCKER_HUB_BACKEND}/pms-invoice-service:latest
                        '''
                    }
                }
                stage('Build Site Service') {
                    steps {
                        sh '''
                            echo "Building Site Service..."
                            docker build -f Site.API/Dockerfile -t ${DOCKER_HUB_BACKEND}/pms-site-service:${BUILD_NUMBER} .
                            docker tag ${DOCKER_HUB_BACKEND}/pms-site-service:${BUILD_NUMBER} ${DOCKER_HUB_BACKEND}/pms-site-service:latest
                        '''
                    }
                }
            }
        }

        stage('Push Backend to Docker Hub') {
            steps {
                withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', usernameVariable: 'DOCKER_USER', passwordVariable: 'DOCKER_PASS')]) {
                    sh '''
                        echo "Logging in to Docker Hub..."
                        echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin

                        echo "Pushing Booking Service..."
                        docker push ${DOCKER_HUB_BACKEND}/pms-booking-service:latest
                        docker push ${DOCKER_HUB_BACKEND}/pms-booking-service:${BUILD_NUMBER}

                        echo "Pushing Invoice Service..."
                        docker push ${DOCKER_HUB_BACKEND}/pms-invoice-service:latest
                        docker push ${DOCKER_HUB_BACKEND}/pms-invoice-service:${BUILD_NUMBER}

                        echo "Pushing Site Service..."
                        docker push ${DOCKER_HUB_BACKEND}/pms-site-service:latest
                        docker push ${DOCKER_HUB_BACKEND}/pms-site-service:${BUILD_NUMBER}
                    '''
                }
            }
        }

        // =============================================
        // STAGE 2: Pull Frontend Images from Docker Hub
        // =============================================
        stage('Pull Frontend Images') {
            steps {
                sh '''
                    echo "=========================================="
                    echo "  Pulling Frontend Images from Docker Hub"
                    echo "=========================================="

                    echo "Pulling Admin Frontend..."
                    docker pull ${DOCKER_HUB_FRONTEND}/pms-admin-frontend:latest

                    echo "Pulling Parker Frontend..."
                    docker pull ${DOCKER_HUB_FRONTEND}/pms-parker-frontend:latest

                    echo ""
                    echo "Frontend images pulled successfully!"
                '''
            }
        }

        // =============================================
        // STAGE 3: Deploy to Docker Swarm
        // =============================================
        stage('Clean Previous Stack') {
            steps {
                sh '''
                    echo "Checking if stack exists..."
                    if docker stack ls | grep -q "${STACK_NAME}"; then
                        echo "Removing existing stack..."
                        docker stack rm ${STACK_NAME}
                        echo "Waiting for stack to be removed..."
                        sleep 20
                    else
                        echo "No existing stack found"
                    fi
                '''
            }
        }

        stage('Deploy Stack') {
            steps {
                dir('testing') {
                    sh '''
                        echo "Deploying full stack to Docker Swarm..."
                        docker stack deploy -c docker-stack.yml ${STACK_NAME}

                        echo ""
                        echo "Waiting for infrastructure services to start..."
                        sleep 30
                    '''
                }
            }
        }

        stage('Wait for Infrastructure') {
            steps {
                sh '''
                    echo "=========================================="
                    echo "  Waiting for Zookeeper..."
                    echo "=========================================="
                    for i in $(seq 1 30); do
                        ZK_CONTAINER=$(docker ps --filter "name=${STACK_NAME}_zookeeper" --format "{{.ID}}" | head -1)
                        if [ -n "$ZK_CONTAINER" ]; then
                            if docker exec $ZK_CONTAINER nc -z localhost 2181 2>/dev/null; then
                                echo "Zookeeper is ready!"
                                break
                            fi
                        fi
                        echo "Waiting for Zookeeper... ($i/30)"
                        sleep 3
                    done

                    echo ""
                    echo "=========================================="
                    echo "  Waiting for Kafka..."
                    echo "=========================================="
                    for i in $(seq 1 60); do
                        KAFKA_CONTAINER=$(docker ps --filter "name=${STACK_NAME}_kafka" --format "{{.ID}}" | head -1)
                        if [ -n "$KAFKA_CONTAINER" ]; then
                            if docker exec $KAFKA_CONTAINER kafka-topics --list --bootstrap-server localhost:9092 2>/dev/null; then
                                echo "Kafka is ready!"
                                break
                            fi
                        fi
                        echo "Waiting for Kafka... ($i/60)"
                        sleep 5
                    done

                    echo ""
                    echo "=========================================="
                    echo "  Waiting for SQL Server..."
                    echo "=========================================="
                    for i in $(seq 1 60); do
                        SQL_CONTAINER=$(docker ps --filter "name=${STACK_NAME}_sqlserver" --format "{{.ID}}" | head -1)
                        if [ -n "$SQL_CONTAINER" ]; then
                            if docker exec $SQL_CONTAINER /opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P "YourStrong@Passw0rd" -C -Q "SELECT 1" 2>/dev/null; then
                                echo "SQL Server is ready!"
                                break
                            fi
                        fi
                        echo "Waiting for SQL Server... ($i/60)"
                        sleep 5
                    done
                '''
            }
        }

        stage('Create Kafka Topics') {
            steps {
                sh '''
                    echo "=========================================="
                    echo "  Creating Kafka Topics"
                    echo "=========================================="

                    KAFKA_CONTAINER=$(docker ps --filter "name=${STACK_NAME}_kafka" --format "{{.ID}}" | head -1)

                    echo "Creating topics..."
                    docker exec $KAFKA_CONTAINER kafka-topics --create --topic site-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || true
                    docker exec $KAFKA_CONTAINER kafka-topics --create --topic booking-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || true
                    docker exec $KAFKA_CONTAINER kafka-topics --create --topic ticket-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || true
                    docker exec $KAFKA_CONTAINER kafka-topics --create --topic invoice-created --partitions 3 --replication-factor 1 --bootstrap-server localhost:9092 --if-not-exists || true

                    echo ""
                    echo "Topics created. Listing all topics:"
                    docker exec $KAFKA_CONTAINER kafka-topics --list --bootstrap-server localhost:9092

                    echo ""
                    echo "Waiting for topics to propagate..."
                    sleep 10
                '''
            }
        }

        stage('Start Backend Services') {
            steps {
                sh '''
                    echo "=========================================="
                    echo "  Starting Backend Services"
                    echo "=========================================="
                    echo "Starting backend services (infrastructure is ready)..."
                    docker service scale ${STACK_NAME}_booking-service=1 ${STACK_NAME}_invoice-service=1 ${STACK_NAME}_site-service=1 --detach

                    echo "Services starting, waiting for them to initialize..."
                    sleep 60
                '''
            }
        }

        stage('Verify Deployment') {
            steps {
                sh '''
                    echo "==========================================="
                    echo "  Stack Services Status"
                    echo "==========================================="
                    docker stack services ${STACK_NAME}

                    echo ""
                    echo "==========================================="
                    echo "  Running Containers"
                    echo "==========================================="
                    docker ps --filter "name=${STACK_NAME}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
                '''
            }
        }

        stage('Health Check') {
            steps {
                sh '''
                    echo "=========================================="
                    echo "  Checking Backend Services Health"
                    echo "=========================================="

                    echo "Waiting for backend services to initialize..."
                    sleep 30

                    echo "Testing API endpoints..."
                    for i in $(seq 1 20); do
                        BOOKING_OK=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5001/api/booking 2>/dev/null || echo "000")
                        INVOICE_OK=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5002/api/invoice 2>/dev/null || echo "000")
                        SITE_OK=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:5003/api/site 2>/dev/null || echo "000")

                        echo "  Booking: $BOOKING_OK | Invoice: $INVOICE_OK | Site: $SITE_OK"

                        if [ "$BOOKING_OK" = "200" ] && [ "$INVOICE_OK" = "200" ] && [ "$SITE_OK" = "200" ]; then
                            echo ""
                            echo "All services are healthy!"
                            break
                        fi
                        echo "Waiting for services... ($i/20)"
                        sleep 10
                    done

                    echo ""
                    echo "=== Final Service Status ==="
                    docker stack services ${STACK_NAME}
                '''
            }
        }
    }

    post {
        success {
            sh '''
                echo ""
                echo "==========================================="
                echo "  DEPLOYMENT SUCCESSFUL!"
                echo "==========================================="
                echo ""
                echo "Access URLs:"
                echo "  Admin Frontend:   http://localhost:4200"
                echo "  Parker Frontend:  http://localhost:4201"
                echo ""
                echo "Monitoring:"
                echo "  Kibana:           http://localhost:5601"
                echo "  Elasticsearch:    http://localhost:9200"
                echo "  Kafka UI:         http://localhost:8085"
                echo "  Swarm Visualizer: http://localhost:9080"
                echo ""
                echo "API Endpoints:"
                echo "  Booking API:      http://localhost:5001/api/booking"
                echo "  Invoice API:      http://localhost:5002/api/invoice"
                echo "  Site API:         http://localhost:5003/api/site"
                echo ""
            '''
        }
        failure {
            sh '''
                echo "=== Deployment Failed ==="
                docker stack services ${STACK_NAME} || true
                docker stack ps ${STACK_NAME} --no-trunc || true
            '''
        }
        always {
            sh 'docker logout || true'
        }
    }
}
